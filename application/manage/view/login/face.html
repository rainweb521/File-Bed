<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!--<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">-->
    <title>人脸检测</title>
     <script src="http://cos.rain1024.com/blog/static/js/jquery.min.js"></script>
     <script src="http://cos.rain1024.com/blog/static/js/layer/layer.js"></script>
    <script src="/public/js/jquery-1.11.0.min.js" type="text/javascript" charset="utf-8"></script>
    <script>

        function rainclick(text,time){
            layer.open({
                type: 1,
                title:false,
                time: time,
                // skin: 'layui-layer-rim', //加上边框
                closeBtn: 0,
                shadeClose: true,
                area: ['420px', '320px'], //宽高
                content: text
            });
        }

        //判断浏览器是否支持HTML5 Canvas
        window.onload = function () {

            try {
                //动态创建一个canvas元 ，并获取他2Dcontext。如果出现异常则表示不支持 document.createElement("canvas").getContext("2d");
                // document.getElementById("support").innerHTML = "浏览器支持HTML5 CANVAS";
            }
            catch (e) {
                // document.getElementByIdx("support").innerHTML = "浏览器不支持HTML5 CANVAS";
            }
        };



        //这段代 主要是获取摄像头的视频流并显示在Video 签中
        window.addEventListener("DOMContentLoaded", function () {
            var canvas = document.getElementById("canvas"),
                context = canvas.getContext("2d"),
                video = document.getElementById("video"),
                videoObj = { "video": true },
                errBack = function (error) {
                    console.log("Video capture error: ", error.code);
                };
            function time_begin(){
                var flag = document.getElementById('flag').innerHTML;
                if (flag=='0') {
                    context.drawImage(video, 0, 0, 630, 300);
                    document.getElementById('flag2').innerHTML = document.getElementById('flag2').innerHTML + '0';
                    CatchCode();
                }else{
                    // alert("$32");
                    // document.getElementById('flag2').innerHTML = document.getElementById('flag2').innerHTML + '1';

                }

            }
            //拍照按钮
		$("#snap").click(function () {
            // document.getElementById('image1').src = '/public/uploads/20180525/0af2110980d6554a84a326b0b07ba4cb.png';
			context.drawImage(video, 0, 0, 630, 300);
            CatchCode();
			});
            //拍照每秒一次

             setInterval(time_begin,1000);
            //navigator.getUserMedia这个写法在Opera中好像是navigator.getUserMedianow
            //更新兼容火狐浏览器
            if (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia) {
                navigator.getUserMedia=navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                navigator.getUserMedia(videoObj, function (stream) {
                    video.srcObject  = stream;
                    video.play();
                }, errBack);
            }

        }, false);

        function dataURItoBlob(base64Data) {
            var byteString;
            if (base64Data.split(',')[0].indexOf('base64') >= 0)
                byteString = atob(base64Data.split(',')[1]);
            else
                byteString = unescape(base64Data.split(',')[1]);
            var mimeString = base64Data.split(',')[0].split(':')[1].split(';')[0];
            var ia = new Uint8Array(byteString.length);
            for (var i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ia], {type:mimeString});
        }
        function flag_value(value){
            document.getElementById('flag').innerHTML = value;
            // var flag = document.getElementById('flag').innerHTML;
            // alert(flag);
        }
        function flag_value2(time){
            setTimeout(function(){
                document.getElementById('flag').innerHTML = '0';
            }, time);
        }

        //上传服务器
        function CatchCode() {
            // // 防止定时函数捣乱
            flag_value(1);
            var canvans = document.getElementById("canvas");
            //获取浏览器页面的画布对象
            //以下开始编 数据
            var imageBase64 = canvans.toDataURL();
            var blob = dataURItoBlob(imageBase64);  // 上一步中的函数
            var fd = new FormData(document.forms[0]);
            fd.append("the_file", blob, 'image.png');
            //将图像转换为base64数据
            $.ajax({
                type:"POST",
                url:"/index.php/manage/login/door_ajax",
                processData: false,     // 必须
                contentType: false,     // 必须
                data:fd,
                datatype: "json",
                success:function(data) {
                    var mes = (data);
                    if(mes.state=='-1'){
                        document.getElementById('contentHolder').style.display = 'none';
                        document.getElementById('title').style.color = 'red';
                        document.getElementById('title').innerHTML = '登录失败次数过多，禁止登录';


                }else if (mes.state=='1'){

                        text = '<div align="center">' +
                            '<span style="color:red;">未在数据库中找到您的人脸信息</span><br><br>' +
                            '<img src="'+mes.image1+'">' +
                            '</div>';
                        rainclick(text,3000);
                        // 将flag的值还原为0，方便检测
                        flag_value2(3000);
                    }else if (mes.state=='2'){

                        text = '<div align="center">' +
                            '<br><span style="color:green;">相似度'+mes.scoure+'% 人脸识别验证通过</span><br><br>' +
                            '<img src="'+mes.image1+'">' +
                            '</div>';
                        rainclick(text,5000);
                        // 将flag的值还原为0，方便检测
                        flag_value2(5000);
                    }else{
                        //未识别到人脸，不做处理
                        document.getElementById('flag').innerHTML = '0';

                    }
                },
                error: function(){
                    //请求出错处理
                    alert("出情况了，请找管理员");
                }
            });
        }

    </script>
    <style>
        .div-a{ width:40%;height:60%;margin: auto;}
        .div-b{ float:right;width:59%;height:60%;border:1px solid #000}
        .div-c{ float:right;width:100%;height:40%;margin-top: 1%; border:1px solid #000}
        .div-d{ float:left;width:40%;height:60%;margin-right: 1%;margin-left: 5%;text-align: center;}
        .div-e{ float:left;width:40%;height:60%;margin-left: 1%;text-align: center;}
        .state{ width:80%;height:10%;margin-left: 1%;text-align: center;font-size: 30px;}
        span{ font-size:25px }
    </style>

</head>
<body style="background-image: url('/public/img/9.jpg')" >
<h1 align="center" id="title">人脸登录</h1>
<!-- 左边区域 -->
<div class="div-a" id="contentHolder" align="center">
    <video id="video" width="100%" height="100%" autoplay></video>
    <canvas style="" hidden="hidden"  id="canvas" width="520" height="250"></canvas>
</div>
<!--<a href="javascript:;" onclick="rainclick()" id="about">关于</a>-->
<!--<div  id="snap">snap</div>-->
<div id="flag" style="font-size: 40px;display: none;">0</div>
<div id="flag2" style="font-size: 40px;display: none;">0</div>
</body>
</html>